# STM32MP157PRO 环境部署

硬件环境：100ASK_STM32MP157_V11

## 拨码开关（BOOT CFG 表格）

|      | EMMC     | SD           | USB      | M4     |
| ---- | -------- | ------------ | -------- | ------ |
| 1    | OFF      | **ON**       | OFF      | OFF    |
| 2    | **ON**   | OFF          | OFF      | OFF    |
| 3    | OFF      | **ON**       | OFF      | **ON** |
| 备注 | 正常启动 | 从 SD 卡启动 | 烧写系统 | 调试   |

## 接线规则（从开发板背面看编号）

- 开发板正面接线图：<https://pan.quark.cn/s/532f2b7cc07d>
- 开发板背面接线图：<https://pan.quark.cn/s/b78f6941857c>
- `J5 USB Serial`：串口（内核）日志，波特率 115200
- `J18 OTG`：烧录口（对应通用串行总线设备中的 DFU）
- `J10 NET1`：SSH 登录开发板（需要使用以太网转换器连接 PC）
- `J11 NET2`：使用网线直接连接到路由器上
- `J3 BOOT CFG`：拨码开关，正常使用选择 EMMC 模式

## 烧写系统

- 烧录工具：[STM32CubeProgrammer](https://pan.quark.cn/s/1a50bbd2fbac)（安装路径不能有中文）
- 下载固件：<https://pan.quark.cn/s/3619f69a933b>

更新整个系统的烧写方式：

- 关闭电源，将 `J18 OTG` 接到 PC 上，将拨码开关设置为从 USB 启动
- 打开电源
- 打开 STM32CubeProgrammer，选择 `USB` > 在 `USB configuration` 中点击刷新按钮，Port 选择 `USB1` > 选择 `connect`
- 解压下载好的固件：[Buildroot_2020.zip](https://pan.quark.cn/s/3619f69a933b)
- 选择分区配置文件：点击 `Open File`，选择 `Buildroot_2020/Flashlayout/Buildroot_Emmc_Systemall.tsv`
- `Binaries path` 选择 `uImage` 所在的目录，也就是 `Buildroot_2020/`
- 点击 `Dwonload` 开始烧写，烧写过程中不要中断电源
- 烧写成功，关闭电源，将启动方式设置为 EMMC，打开电源

单独更新 Trust Boot，基本步骤同上，在选择分区配置文件时，选择 `Buildroot_2020/Flashlayout/Buildroot_Emmc_TrustUbootBootloader.tsv`

## 使用开发板：网络配置

串口登录开发板：输入 root，没有密码。配置网络：

```bash
cat <<EOF | tee /etc/systemd/network/50-static.network
[Match]
Name=eth0
[Network]
Address=192.168.5.9/24
Gateway=192.168.5.1
EOF

systemctl enable systemd-networkd
```

下载虚拟机：<https://pan.quark.cn/s/278d398939e4>（用户名：`root`，密码：`123456`）

双击 ubuntu18.04_x64.vmx 用 VMware Workstation Pro 打开虚拟机，配置虚拟机桥接网卡（用于和开发板互相通信）

```bash
虚拟机 - 设置 - 添加 - 网络适配器 - 桥接模式 - 复制物理网络连接状态
编辑 - 虚拟网络编辑器 - 更改设置 - 添加网络 - VMnet0 - 桥接模式选择 AXIC 网络适配器 - 应用 - 确定
```

```bash
cat <<EOF | sudo tee /etc/netplan/99_config.yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    ens33:
      dhcp4: true
      optional: true
    ens36:
      addresses:
        - 192.168.5.11/24
      routes:
        - to: 192.168.0.0/24
          via: 192.168.5.1
          metric: 100
EOF

sudo netplan apply
```

配置电脑端 AXIC 网络适配器的 IPv4 和网关（用于和开发板和虚拟机通信）

```bash
更改 AXIC 网络适配器属性

IPv4    : 192.168.5.10
Netmask : 255.255.255.0
Gateway : 192.168.5.1

关闭 Windows 公用网络防火墙
```

## 开发板上网

```{note}
接上网线后执行 `udhcpc -i eth1`。
```

## 编码和调试（二次开发）

### 代码编辑器

- 下载 [STM32CubeMX](https://pan.quark.cn/s/b1be5a3d9b68)（设置硬件引脚，生成 HAL 层代码）
- 下载 [STM32CubeIDE](https://pan.quark.cn/s/8b8cb53b823e)（编写业务代码）

### 下载内核源代码和构建工具

```bash
mkdir -p stm32mp-ya15xc && cd stm32mp-ya15xc
repo init -u git@gitee.com:zhyantao/manifest.git -b stm32mp-ya15xc -m STM32MP157_V11.xml
repo sync -j8
```

### 编译生成 SDK 和工具链

```bash
# 安装必要的编译工具链和依赖包
sudo apt install -y build-essential make unzip
cd Buildroot_2020.02.x

# 删除系统默认的 python 符号链接（通常是 python3）
sudo rm /usr/bin/python
sudo ln -s /usr/bin/python2 /usr/bin/python

# 加载特定开发板的配置文件
# 100ask_stm32mp157_pro_ddr512m_systemD_qt5_defconfig 包含：
# - 目标平台：STM32MP157 Pro版
# - 内存配置：512MB DDR
# - 初始化系统：systemd
# - 图形界面：QT5
make 100ask_stm32mp157_pro_ddr512m_systemD_qt5_defconfig

# 开始完整编译，使用 4 个并行任务加速编译过程
make all -j4

# 生成 SDK 工具链，用于后续应用程序开发
# 该工具链将包含交叉编译器、库文件等
make sdk
```

````{admonition} tree output/images/
```
output/images/
├── rootfs.ext2                 # 根文件系统镜像（ext2 格式）
├── rootfs.ext4 -> rootfs.ext2  # ext4 格式的符号链接（实际仍为 ext2）
├── sdcard.img                  # 完整的 SD 卡镜像，可直接烧录
├── stm32mp157c-dk2.dtb         # 设备树二进制文件，描述硬件配置
├── tf-a-stm32mp157c-dk2.stm32  # TF-A 固件（ARM Trusted Firmware）
├── u-boot.stm32                # U-Boot 引导加载程序镜像
└── zImage                      # 压缩的内核镜像
```
````

````{admonition} tree output/host/bin/
```
output/host/bin/
# 该目录存放生成的交叉编译工具链（如 arm-linux-gcc 等）
# 在执行 `make sdk` 后，此目录会被打包到 SDK 中
# 可用于开发针对该嵌入式平台的应用程序
```
````

### 配置交叉编译环境

```bash
export ARCH=arm
export CROSS_COMPILE=arm-buildroot-linux-gnueabihf-
export PATH=$PATH:/home/yantao/workshop/stm32mp-ya15xc/Buildroot_2020.02.x/output/host/usr/bin
```

### 编译 Linux 内核

```bash
cd stm32mp-ya15xc/Linux-5.4/
make 100ask_stm32mp157_pro_defconfig
make uImage LOADADDR=0xC2000040
make dtbs
cp arch/arm/boot/uImage ~/nfs_rootfs/
```

### 安装 Linux 内核

```bash
cd stm32mp-ya15xc/Linux-5.4/
make ARCH=arm CROSS_COMPILE=arm-buildroot-linux-gnueabihf- modules -j8
make ARCH=arm INSTALL_MOD_PATH=/home/book/nfs_rootfs INSTALL_MOD_STRIP=1 modules_install
```

将内核模块安装到开发板

```bash
mount -t nfs -o nolock,vers=3 192.168.5.11:/home/book/nfs_rootfs /mnt
mount /dev/mmcblk2p2 /boot
cp /mnt/uImage /boot
cp /mnt/*.dtb /boot
cp /mnt/lib/modules /lib -rfd
sync
reboot
```

### 编译和安装驱动

```bash
cd 01_all_series_quickstart/05_嵌入式 Linux 驱动开发基础知识/source/01_hello_drv/
make
cp led_drv.ko ledtest ~/nfs_rootfs/
mount -t nfs -o nolock,vers=3 192.168.5.11:/home/book/nfs_rootfs /mnt
cp /mnt/led_drv.ko ./
cp /mnt/ledtest ./
insmod led_drv.ko
lsmod
echo none > /sys/class/leds/heartbeat/trigger # 关掉 led0 的默认呼吸效果
chmod +x ./ledtest
./ledtest /dev/myled on # 打开 led0 灯
```

### 编译 TFA（可选）

仅适用于 STM32MP157PRO 开发板

编译 TFA

```bash
cd /home/book/stm32mp-ya15xc/Tfa-v2.2
make -f $PWD/./Makefile.sdk all
cp tf-a-stm32mp157c-100ask-512d-v1.stm32 ~/nfs_rootfs/
```

更新 TFA

```bash
echo 0 > /sys/class/block/mmcblk2boot0/force_ro
echo 0 > /sys/class/block/mmcblk2boot1/force_ro
dd if=tf-a-stm32mp157c-100ask-512d-v1.stm32 of=/dev/mmcblk2/boot0 conv=fsync > /dev/null 2>&1
dd if=tf-a-stm32mp157c-100ask-512d-v1.stm32 of=/dev/mmcblk2/boot1 conv=fsync > /dev/null 2>&1
echo 1 > /sys/class/block/mmcblk2boot0/force_ro
echo 1 > /sys/class/block/mmcblk2boot1/force_ro
```

### 编译 Bootloader（可选）

编译 Bootloader

```bash
cd /home/book/stm32mp-ya15xc/Uboot-2020.02
make stm32mp15_trusted_defconfig
make DEVICE_TREE=stm32mp157c-100ask-512d-v1 all -j4
cp u-boot.stm32 ~/nfs_rootfs/
```

更新 u-boot 镜像

```bash
dd if=u-boot.stm32 of=/dev/mmcblk2p1 conv=fsync > /dev/null 2>&1
sync
```

### 挂载 NFS 目录

在开发板上执行

```bash
mount -t nfs -o nolock,vers=3 192.168.5.11:~/nfs_rootfs /mnt
```

挂载完成后，在开发板 `/mnt` 目录，可以直接访问虚拟机上 `nfs_rootfs` 文件。
